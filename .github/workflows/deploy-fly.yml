name: Deploy to Fly.io

on:
  push:
    branches: [main]
    paths:
      - 'mcp-servers/**'
      - 'services/**'
  workflow_dispatch:
    inputs:
      target:
        description: 'Which app to deploy'
        required: true
        type: choice
        options:
          - all-changed
          - garza-home-mcp
          - last-rock-dev
          - lrlab-mcp
          - beeper-matrix-mcp
          - beeper-fast-mcp
          - garza-ears
          - jessica-bot
          - email-craft

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changed apps
        id: set-matrix
        run: |
          if [ "${{ github.event.inputs.target }}" != "" ] && [ "${{ github.event.inputs.target }}" != "all-changed" ]; then
            echo "matrix={\"app\":[\"${{ github.event.inputs.target }}\"]}" >> $GITHUB_OUTPUT
          else
            APPS=()
            
            declare -A APP_PATHS=(
              ["garza-home-mcp"]="mcp-servers/garza-home-mcp"
              ["last-rock-dev"]="mcp-servers/last-rock-dev"
              ["lrlab-mcp"]="mcp-servers/lrlab-mcp"
              ["beeper-matrix-mcp"]="mcp-servers/beeper-matrix-mcp"
              ["beeper-fast-mcp"]="mcp-servers/beeper-fast-mcp"
              ["garza-ears"]="services/garza-ears"
              ["jessica-bot"]="services/jessica-bot"
              ["email-craft"]="services/email-craft"
            )
            
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
            
            for app in "${!APP_PATHS[@]}"; do
              path="${APP_PATHS[$app]}"
              if echo "$CHANGED" | grep -q "^$path/"; then
                APPS+=("\"$app\"")
              fi
            done
            
            if [ ${#APPS[@]} -eq 0 ]; then
              echo "No apps changed"
              echo "matrix={\"app\":[]}" >> $GITHUB_OUTPUT
            else
              JOINED=$(IFS=,; echo "${APPS[*]}")
              echo "matrix={\"app\":[$JOINED]}" >> $GITHUB_OUTPUT
            fi
          fi

  deploy:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.matrix != '{"app":[]}' }}
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Determine app path
        id: path
        run: |
          declare -A APP_PATHS=(
            ["garza-home-mcp"]="mcp-servers/garza-home-mcp"
            ["last-rock-dev"]="mcp-servers/last-rock-dev"
            ["lrlab-mcp"]="mcp-servers/lrlab-mcp"
            ["beeper-matrix-mcp"]="mcp-servers/beeper-matrix-mcp"
            ["beeper-fast-mcp"]="mcp-servers/beeper-fast-mcp"
            ["garza-ears"]="services/garza-ears"
            ["jessica-bot"]="services/jessica-bot"
            ["email-craft"]="services/email-craft"
          )
          echo "path=${APP_PATHS[${{ matrix.app }}]}" >> $GITHUB_OUTPUT
      
      - name: Get current release (for rollback)
        id: current
        run: |
          cd ${{ steps.path.outputs.path }}
          # Get current release version before deploy
          CURRENT_VERSION=$(flyctl releases --json 2>/dev/null | jq -r '.[0].Version // "none"') || CURRENT_VERSION="none"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Current version: $CURRENT_VERSION"
      
      - name: Deploy ${{ matrix.app }}
        id: deploy
        run: |
          cd ${{ steps.path.outputs.path }}
          flyctl deploy --remote-only
      
      - name: Health check after deploy
        id: health
        if: success()
        run: |
          # Wait for deploy to stabilize
          sleep 10
          
          # Get app URL and check health
          APP_URL="https://${{ matrix.app }}.fly.dev"
          
          # Try health endpoint
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/health" --max-time 10) || HTTP_STATUS="000"
          
          if [ "$HTTP_STATUS" == "200" ]; then
            echo "‚úÖ Health check passed"
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Health check returned $HTTP_STATUS"
            echo "healthy=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Auto-rollback on failure
        if: failure() || steps.health.outputs.healthy == 'false'
        run: |
          cd ${{ steps.path.outputs.path }}
          PREV_VERSION="${{ steps.current.outputs.version }}"
          
          if [ "$PREV_VERSION" != "none" ] && [ -n "$PREV_VERSION" ]; then
            echo "üîÑ Rolling back to version $PREV_VERSION..."
            flyctl releases rollback "$PREV_VERSION" --yes || echo "Rollback failed"
            
            # Post to callback
            curl -s -X POST "https://workflow-results.jadengarza.workers.dev/result" \
              -H "Content-Type: application/json" \
              -d "{
                \"run_id\": \"${{ github.run_id }}\",
                \"workflow\": \"deploy-fly-rollback\",
                \"host\": \"${{ matrix.app }}\",
                \"command\": \"rollback to $PREV_VERSION\",
                \"output\": \"Auto-rollback triggered\",
                \"status\": \"rollback\"
              }" || true
          else
            echo "‚ùå No previous version to rollback to"
          fi
      
      - name: Post deploy result
        if: always()
        run: |
          curl -s -X POST "https://workflow-results.jadengarza.workers.dev/result" \
            -H "Content-Type: application/json" \
            -d "{
              \"run_id\": \"${{ github.run_id }}\",
              \"workflow\": \"deploy-fly\",
              \"host\": \"${{ matrix.app }}\",
              \"command\": \"flyctl deploy\",
              \"status\": \"${{ job.status }}\"
            }" || true
      
      - name: Notify on success
        if: success() && steps.health.outputs.healthy != 'false'
        run: |
          echo "‚úÖ Deployed ${{ matrix.app }}"
      
      - name: Notify on failure
        if: failure() || steps.health.outputs.healthy == 'false'
        run: |
          curl -s -X POST "https://api.pushcut.io/${{ secrets.PUSHCUT_KEY }}/notifications/Deploy%20Failed" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "‚ùå Deploy Failed: ${{ matrix.app }}",
              "text": "Auto-rollback attempted. Check GitHub Actions.",
              "isTimeSensitive": true
            }' || true
