name: Deploy Cloudflare Workers

on:
  push:
    branches: [main]
    paths:
      - 'workers/**'
  workflow_dispatch:
    inputs:
      worker:
        description: 'Which worker to deploy'
        required: true
        type: choice
        options:
          - all-changed
          - workflow-results
          - log-aggregator
          - jessica-cron
          - garza-mcp
          - garza-health-monitor
          - rate-limiter

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changed workers
        id: set-matrix
        run: |
          if [ "${{ github.event.inputs.worker }}" != "" ] && [ "${{ github.event.inputs.worker }}" != "all-changed" ]; then
            echo "matrix={\"worker\":[\"${{ github.event.inputs.worker }}\"]}" >> $GITHUB_OUTPUT
          else
            WORKERS=()
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
            
            for dir in workers/*/; do
              name=$(basename "$dir")
              if echo "$CHANGED" | grep -q "^workers/$name/"; then
                WORKERS+=("\"$name\"")
              fi
            done
            
            if [ ${#WORKERS[@]} -eq 0 ]; then
              echo "matrix={\"worker\":[]}" >> $GITHUB_OUTPUT
            else
              JOINED=$(IFS=,; echo "${WORKERS[*]}")
              echo "matrix={\"worker\":[$JOINED]}" >> $GITHUB_OUTPUT
            fi
          fi

  deploy:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.matrix != '{"worker":[]}' }}
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Deploy ${{ matrix.worker }}
        working-directory: workers/${{ matrix.worker }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: wrangler deploy
      
      - name: Post deploy result
        if: always()
        run: |
          # Only post if workflow-results is deployed (avoid circular dependency on first deploy)
          if [ "${{ matrix.worker }}" != "workflow-results" ]; then
            curl -s -X POST "https://workflow-results.jadengarza.workers.dev/result" \
              -H "Content-Type: application/json" \
              -d "{
                \"run_id\": \"${{ github.run_id }}\",
                \"workflow\": \"deploy-cloudflare\",
                \"host\": \"${{ matrix.worker }}\",
                \"command\": \"wrangler deploy\",
                \"status\": \"${{ job.status }}\"
              }" || true
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          curl -s -X POST "https://api.pushcut.io/${{ secrets.PUSHCUT_KEY }}/notifications/Worker%20Deploy%20Failed" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "‚ùå Worker Deploy Failed",
              "text": "${{ matrix.worker }} failed to deploy",
              "isTimeSensitive": true
            }' || true
