name: Health Check All Services

on:
  workflow_dispatch:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml requests
      
      - name: Run Health Checks
        id: health
        run: |
          python3 << 'PYEOF'
          import json
          import yaml
          import requests
          from datetime import datetime, timezone
          
          # Load services config
          with open('infra/services.yml', 'r') as f:
              services = yaml.safe_load(f)
          
          results = {
              "timestamp": datetime.now(timezone.utc).isoformat(),
              "checks": {},
              "summary": {
                  "total": 0,
                  "healthy": 0,
                  "unhealthy": 0,
                  "unknown": 0
              }
          }
          
          # Check MCP servers
          for name, config in services.get('mcp_servers', {}).items():
              results["summary"]["total"] += 1
              
              if 'health_check' in config and 'endpoint' in config['health_check']:
                  url = config['url'] + config['health_check']['endpoint']
                  try:
                      resp = requests.get(url, timeout=config['health_check'].get('timeout_seconds', 10))
                      
                      if resp.status_code == config['health_check'].get('expected_status', 200):
                          results["checks"][name] = {
                              "status": "healthy",
                              "response_time_ms": int(resp.elapsed.total_seconds() * 1000)
                          }
                          results["summary"]["healthy"] += 1
                          print(f"âœ… {name}: healthy ({resp.status_code})")
                      else:
                          results["checks"][name] = {
                              "status": "unhealthy",
                              "error": f"Status {resp.status_code}"
                          }
                          results["summary"]["unhealthy"] += 1
                          print(f"âŒ {name}: unhealthy (status {resp.status_code})")
                  
                  except Exception as e:
                      results["checks"][name] = {
                          "status": "unhealthy",
                          "error": str(e)
                      }
                      results["summary"]["unhealthy"] += 1
                      print(f"âŒ {name}: error - {e}")
              else:
                  results["checks"][name] = {"status": "unknown", "reason": "no_http_check"}
                  results["summary"]["unknown"] += 1
          
          # Check Workers
          for name, config in services.get('workers', {}).items():
              results["summary"]["total"] += 1
              
              if 'health_check' in config and 'endpoint' in config['health_check']:
                  url = config['url'] + config['health_check']['endpoint']
                  try:
                      resp = requests.get(url, timeout=5)
                      
                      if resp.status_code == 200:
                          results["checks"][name] = {
                              "status": "healthy",
                              "response_time_ms": int(resp.elapsed.total_seconds() * 1000)
                          }
                          results["summary"]["healthy"] += 1
                          print(f"âœ… {name}: healthy")
                      else:
                          results["checks"][name] = {
                              "status": "unhealthy",
                              "error": f"Status {resp.status_code}"
                          }
                          results["summary"]["unhealthy"] += 1
                          print(f"âŒ {name}: unhealthy")
                  
                  except Exception as e:
                      results["checks"][name] = {
                          "status": "unhealthy",
                          "error": str(e)
                      }
                      results["summary"]["unhealthy"] += 1
                      print(f"âŒ {name}: error - {e}")
          
          # Save results
          with open('health-results.json', 'w') as f:
              json.dump(results, f, indent=2)
          
          # Print summary
          print(f"\nðŸ“Š Summary:")
          print(f"  Total: {results['summary']['total']}")
          print(f"  Healthy: {results['summary']['healthy']} âœ…")
          print(f"  Unhealthy: {results['summary']['unhealthy']} âŒ")
          print(f"  Unknown: {results['summary']['unknown']} âš ï¸")
          
          # Set outputs
          print(f"healthy={results['summary']['healthy']}")
          print(f"unhealthy={results['summary']['unhealthy']}")
          PYEOF
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: health-check-results
          path: health-results.json
          retention-days: 7
      
      - name: Alert on Failures
        if: failure()
        run: |
          echo "ðŸš¨ Health check detected failures"
          # Future: Send Pushcut notification
