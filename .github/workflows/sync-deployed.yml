name: Sync DEPLOYED.yml Status

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write  # Required to push commits

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Check Fly Apps
        run: |
          echo "## Fly.io Apps Health Check" >> $GITHUB_STEP_SUMMARY
          echo "| App | Status | Response Time |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|---------------|" >> $GITHUB_STEP_SUMMARY
          
          for app in $(yq '.fly_apps | keys | .[]' DEPLOYED.yml 2>/dev/null || echo ""); do
            url=$(yq ".fly_apps.${app}.url" DEPLOYED.yml)
            health=$(yq ".fly_apps.${app}.health // \"/health\"" DEPLOYED.yml)
            
            if [ "$url" != "null" ] && [ -n "$url" ]; then
              start=$(date +%s%N)
              status=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${url}${health}" 2>/dev/null || echo "000")
              end=$(date +%s%N)
              ms=$(( (end - start) / 1000000 ))
              
              if [ "$status" = "200" ]; then
                echo "| ${app} | ✅ ${status} | ${ms}ms |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| ${app} | ❌ ${status} | ${ms}ms |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
      
      - name: Check Cloudflare Workers
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cloudflare Workers Health Check" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for worker in $(yq '.cloudflare_workers | keys | .[]' DEPLOYED.yml 2>/dev/null || echo ""); do
            url=$(yq ".cloudflare_workers.${worker}.url" DEPLOYED.yml)
            
            if [ "$url" != "null" ] && [ -n "$url" ]; then
              status=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${url}" 2>/dev/null || echo "000")
              
              if [ "$status" = "200" ] || [ "$status" = "204" ]; then
                echo "| ${worker} | ✅ ${status} |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| ${worker} | ⚠️ ${status} |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
      
      - name: Update status timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          yq -i ".metadata.last_health_check = \"$TIMESTAMP\"" DEPLOYED.yml
          cat DEPLOYED.yml | grep last_health_check
          
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add DEPLOYED.yml
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update health check timestamp [skip ci]"
            git push
            echo "✓ Pushed timestamp update"
          fi
