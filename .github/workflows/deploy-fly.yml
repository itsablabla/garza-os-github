name: Deploy to Fly.io

on:
  push:
    branches: [main]
    paths:
      - 'mcp-servers/**'
      - 'services/**'
  workflow_dispatch:
    inputs:
      target:
        description: 'Which app to deploy'
        required: true
        type: choice
        options:
          - all-changed
          - garza-home-mcp
          - last-rock-dev
          - lrlab-mcp
          - beeper-matrix-mcp
          - beeper-fast-mcp
          - garza-ears
          - jessica-bot
          - email-craft

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changed apps
        id: set-matrix
        run: |
          if [ "${{ github.event.inputs.target }}" != "" ] && [ "${{ github.event.inputs.target }}" != "all-changed" ]; then
            # Manual trigger for specific app
            echo "matrix={\"app\":[\"${{ github.event.inputs.target }}\"]}" >> $GITHUB_OUTPUT
          else
            # Auto-detect from changed files
            APPS=()
            
            # Check each app directory
            declare -A APP_PATHS=(
              ["garza-home-mcp"]="mcp-servers/garza-home-mcp"
              ["last-rock-dev"]="mcp-servers/last-rock-dev"
              ["lrlab-mcp"]="mcp-servers/lrlab-mcp"
              ["beeper-matrix-mcp"]="mcp-servers/beeper-matrix-mcp"
              ["beeper-fast-mcp"]="mcp-servers/beeper-fast-mcp"
              ["garza-ears"]="services/garza-ears"
              ["jessica-bot"]="services/jessica-bot"
              ["email-craft"]="services/email-craft"
            )
            
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
            
            for app in "${!APP_PATHS[@]}"; do
              path="${APP_PATHS[$app]}"
              if echo "$CHANGED" | grep -q "^$path/"; then
                APPS+=("\"$app\"")
              fi
            done
            
            if [ ${#APPS[@]} -eq 0 ]; then
              echo "No apps changed"
              echo "matrix={\"app\":[]}" >> $GITHUB_OUTPUT
            else
              JOINED=$(IFS=,; echo "${APPS[*]}")
              echo "matrix={\"app\":[$JOINED]}" >> $GITHUB_OUTPUT
            fi
          fi

  deploy:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.matrix != '{"app":[]}' }}
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Determine app path
        id: path
        run: |
          declare -A APP_PATHS=(
            ["garza-home-mcp"]="mcp-servers/garza-home-mcp"
            ["last-rock-dev"]="mcp-servers/last-rock-dev"
            ["lrlab-mcp"]="mcp-servers/lrlab-mcp"
            ["beeper-matrix-mcp"]="mcp-servers/beeper-matrix-mcp"
            ["beeper-fast-mcp"]="mcp-servers/beeper-fast-mcp"
            ["garza-ears"]="services/garza-ears"
            ["jessica-bot"]="services/jessica-bot"
            ["email-craft"]="services/email-craft"
          )
          echo "path=${APP_PATHS[${{ matrix.app }}]}" >> $GITHUB_OUTPUT
      
      - name: Deploy ${{ matrix.app }}
        run: |
          cd ${{ steps.path.outputs.path }}
          flyctl deploy --remote-only
      
      - name: Notify on success
        if: success()
        run: |
          echo "✅ Deployed ${{ matrix.app }}"
      
      - name: Notify on failure
        if: failure()
        run: |
          curl -X POST "https://api.pushcut.io/${{ secrets.PUSHCUT_API_KEY }}/notifications/GARZA%20OS%20Alert" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "❌ Deploy Failed",
              "text": "${{ matrix.app }} failed to deploy",
              "isTimeSensitive": true
            }'
